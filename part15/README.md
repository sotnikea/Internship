# Архитектура Windows NT. Часть 1. (OS)
## Зміст
1. [Віртуальний адресний простір](#r1)
2. [Регіони адресного простіру](#r2)
3. [Розмежування доступу kernel/user](#r3)
4. [Основні компоненти виконавчої системи](#r4)
5. [Об'єкти системи](#r5)
6. [Потік виконання (thread)](#r6)
7. [IRQL (Interrupt ReQuest Level)](#r7)


## <a name="r1">Віртуальний адресний простір</a>
**Віртуальний адресний простір** -  механізм розподілу та використання оперативной пам’яті.  
Властивості механізму в ОС лінійці NT:
-	кожному процесу виділяється свій адресний простір. Код процесу, який виконується в режимі користувача, не може отримати доступ до приватних регіонів пам'яті чужого процесу без використання спеціального API;
-	ВАП розбивається на сторінки рівного розміру, зазвичай 4КБ. Кожна сторінка має свій стан: відсутня, знаходиться у фізичній пам'яті, спільно використовується, скинута на диск тощо; 
-	кожен процес містить у собі таблиці дескрипторів сторінок, котрі визначають як його віртуальні адреси транслюються у фізичні (PTD/PTE).

## <a name="r2">Регіони адресного простіру</a>
-	адресний простір поділяється на регіони, що виділяються ОС для різних цілей. Регіони можуть бути приватними чи спільно використовуваними; 
-	половина адресного простору < 2^(N-1) зазвичай зарезервована ОС для використання в режимі користувача (де N - розрядність шини процесора, 32 або 64);
-	друга половина, що починається з 2^(N-1), зарезервована для використання в режимі ядра;
-	більшість пам'яті режиму ядра (kernel space) транслюється однаково у всіх процесах. (в тому числі відображається в ту саму фізичну пам'ять);
-	в kernel space розміщується виконавча система ОС Windows, а також більшість драйверів режиму ядра.

## <a name="r3">Розмежування доступу kernel/user</a>
-	будь-який код в момент виконання знаходиться або в режимі користувача (ring 3), або режимі ядра (ring 0);
-	перехід у режим ядра здійснюється за допомогою програмних чи апаратних переривань;
-	код у режимі ring 3 не може використовувати привілейовані команди та команди для роботи із зовнішніми пристроями (in, out);
-	код у режимі ring 3 не може використовувати адреси та дескріптори режиму ядра;
-	код у режимі ring 3 повинен проходити перевірку прав (access check);

## <a name="r4">Основні компоненти виконавчої системи</a>
-	Object Manager (Ob);
-	Memory Manager (Mm);
-	Process Structure (Ps);
-	Dispatcher/Scheduler (Ke);
-	Input/Output subsystem (Io);

## <a name="r5">Об'єкти системи</a>
**Об'єкти системи** представлені в ядерному просторі у вигляді частково документованих plain-C структур та набору функцій для роботи з ними. 
-	доступ до полей структури здійснюється виключно за допомогою АПІ; 
-	на відміну від ring 3 коду, який використовує хендли (дескриптори) для доступу до об’єктів, драйверний код може використовувати вказівники на об'єкти; 
-	кожен об'єкт містить у собі лічильник посилань, за допомогою якого регулюється час життя об’єкта.

## <a name="r6">Потік виконання (thread)</a>
**Потік виконання (thread)** – єдина сутність у сімействі Windows NT що виконується.
-	кожен процес зазвичай містить ненульову кількість потоків; 
-	кожен потік містить свій контекст (поточну позицію виконання, набір регістрів); 
-	в ОС NT використовується витискальна багатозадачність.

## <a name="r7">IRQL (Interrupt ReQuest Level)</a>
**IRQL (Interrupt ReQuest Level)** – рівень запиту переривання.  
IRQL є програмним атрибутом процесора та вказує пріоритет коду, що виконується на цьому процесорі **відносно переривань та інших асинхронних подій**. Важливо: не плутати із пріоритетом потока виконання.  
Властивості:  
-	кожне ядро процесора, а отже і поток в момент виконання, має атрибут – поточне значення IRQL;
-	код режиму користувача виконується лише на IRQL == Passive Level, він може в будь який момент бути витісненим як планувальником так і апартним перериванням;
-	код, IRQL якого вище або дорівнює DPC/DISPATCH, не бере участь у плануванні потоків і може бути витісненим лише апаратним перериванням; 
-	код з IRQL = X (X >= DISPATCH), може бути витісненим лише кодом з IRQL > X; 
-	потік з IRQL >= DISPATCH має обмеження: він не може очікувати подіі інших потоків, використовувати більшість засобів синхронізації; 
-	отже, потік з IRQL >= DISPATCH не може використовувати пам'ять яка може бути переміщена на жорсткий диск, файлову систему, більшу частину системних сервісів.

