# Архитектура Windows NT. Часть 2. (Драйвера)
## Зміст
1. [Драйвер](#r1)
2. [Типи драйверів](#r2)



## <a name="r1">Драйвер</a>
**Драйвер** режиму ядра – файл формату Portable Executable (PE), який завантажується в ядерний адресний простір. У якомусь сенсі драйвер – це plug-in до ОС, що розширює її можливості.  

Точка входу в драйвер (зазвичай) – функція **DriverEntry**, викликається в контексті процесу System. Як правило, взаємодія з драйвером відбувається в контексті пристроїв (Devices), які можуть бути як доступні з режиму користувача так і ні. Драйвер може використовувати функції виконавчої системи, що експортуються (ntoskernel.exe).  

Деякі види драйверів:
-	File systems;
-	File system filters/Minifilters;
-	Storage devices/Ports/Miniports;
-	NDIS;
-	WSK/TDI;
-	System bus (PCI/USB etc);

## <a name="r2">Типи драйверів</a>
-	**Legacy**. Створюють незалежний пристрій (або кілька пристроїв) в DriverEntry для взаємодії з режимом користувача;
-	**WDM**. Реєструють функцію AddDevice в DriverEntry. Коли операційна система викликає AddDevice, драйвер створюює функціональний пристрій FDO, пов'язуючи його з фізичним пристроєм PDO, наданим ОС та іншим драйвером.  

Драйвери та виконавча система перевіряють звідки надійшло управління за допомогою функції **KeGetPreviosMode**, і, виходячи з отриманого значення PreviosMode, дозволяють або забороняють коду, що викликає, використовувати ядерні дескриптори та адреси.  

У більш низькорівневих компонентах, наприклад Io або Ob, необхідний PreviosMode можна іноді вказувати в параметрах виклику. Щоб замінити PreviosMode на KernelMode, перед викликом Nt-функції використовуються автогенеровані Zw-функції виконавчої системи. 

**Драйвер може виділити динамічну пам'ять:**
-	**Paged Pool** - пул режиму ядра, що містить сторінки, які у будь-який момент можуть бути скинуті на диск (ExAllocatePoolEx + PagedPool);
-	**NonPaged Pool** – пул режиму ядра, сторінки якого не можуть бути скинуті на диск (ExAllocatePoolEx + NonPagedPool);
-	У контексті викликаючого процесу **Zw/NtAllocateVirtualMemory**.

